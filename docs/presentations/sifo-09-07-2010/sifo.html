<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" content-t>

<head>
<title>Seoframework (SIFO) tips</title>
<!-- metadata -->
<meta name="generator" content="S5" />
<meta name="version" content="S5 1.1" />
<meta name="presdate" content="20100709" />
<meta name="author" content="Albert Lombarte" />
<meta name="company" content="SIFO" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<!-- style sheet links -->
<link rel="stylesheet" href="ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/default/print.css" type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/default/opera.css" type="text/css" media="projection" id="operaFix" />
<!-- embedded styles -->
<style type="text/css" media="all">
.imgcon {width: 525px; margin: 0 auto; padding: 0; text-align: center;}
#anim {width: 270px; height: 320px; position: relative; margin-top: 0.5em;}
#anim img {position: absolute; top: 42px; left: 24px;}
img#me01 {top: 0; left: 0;}
img#me02 {left: 23px;}
img#me04 {top: 44px;}
img#me05 {top: 43px;left: 36px;}
</style>
<!-- S5 JS -->
<script src="ui/default/slides.js" type="text/javascript"></script>
</head>
<body>

<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer">
<h1>The awesome SIFO experience</h1>
<h2>Albert Lombarte &#8226; alombarte@gmail.com</h2>
</div>

</div>
<div class="presentation">

<div class="slide">
<h1>The awesome SIFO experience</h1>
<h3>Albert Lombarte</h3>
<h4><a href="http://sifo.eu/">Reverend of the SIFO Church</a></h4>
<h5><em>Twitter:</em> <a href="http://twitter.com/alombarte">@alombarte</a></h5>
</div>

<div class="slide">
<h1>Quick overview</h1>
<ul>
<li>Project Name: <strong>SEOFramework</strong>. Using SIFO as codename</li>
<li>Created by myself as a general solution for creating webs</li>
<li>First project online with SIFO: Uvinum</li>
<li>Migrated Splitweet from procedural code</li>
<li>Sergi Ambel joined as Core developer in Dec. 2009, Albert Garcia also contributes the core.</li>
</ul>
</div>

<div class="slide">
<h1>Who is using SEOframework</h1>
<ul>
<li>Uvinum</li>
<li>Splitweet</li>
<li>Obolog</li>
<li>Onswingers</li>
<li>Programas-buenos</li>
<li>Enigdoo</li>
<li>Senderators</li>
<li>MusicJumble</li>
<li>Anyone else?</li>
</ul>
</div>

<div class="slide">
	<h1>Let's code!</h1>
	<p>What are we seeing:</p>
	<ul>
		<li>Hacks</li>
		<li>Things that aren't obvious</li>
		<li>Solve common problems</li>
	</ul>
</div>
<div class="slide black">
	<span class="banner">Hacks</span>
</div>

<div class="slide">
	<h1>Infinite Nesting in modules</h1>
	<p class="problem"><strong>Problem:</strong> I need a Sub-sub-sub-sub module inside my sub-module</p>
	<ol>
	<li>Use <code>addModule()</code> inside <strong>ANY level</strong> of controller (tpl: <code>{$modules.xxx}</code>)</li>
	<li><strong>Execute it in runtime</strong> and fetch the output:
<pre>
	$this->assign( 'myhtml', <strong>$this->dispatchSingleController</strong>(
		'SharedSubSubModuleController', $params
		) );;
</pre>
	</li>
	<li><strong>Fetch a smarty template N times</strong> inside the Controller (newsletters?)
	<pre>
	foreach( $spammed_users as $user ) {
		$this->assign( 'user', $user['fullname'] );	
		sendEmail( $user['email'],<strong> $this->fetch()</strong> )

	}
	</pre>
	</li>
	</ol>
</div>

<div class="slide">
<h1>Invalid caches stored too long</h1>
<p class="problem"><strong>Problem:</strong> I just saved for 12 hours a cache that I know is invalid</p>
<ol>
	<li><strong>Set a ridiculous TTL</strong> before end of controller when something went wrong:
<pre>
if ( $somethingWentWrong ){
	// Expire cache in 5 seconds
	$this->setCacheExpiration( 5 );
	$this->setCacheName( $new_name ); // You can also change the name
}
</pre>		
	</li>
	<li>Delete Cache using <code>$this->deleteCache( $key )</code> in Controllers</li>
</ol>
</div>

<div class="slide">
<h1>Router: Map subdomains</h1>
<p class="problem"><strong>Problem:</strong> My subdomains are dinamic and unknown a priori. How router would recognize them?</p>
<ol>
	<li>Did you know that configuration files parse code as well?</li>
	<li>Map current subdomain (whatever it is) to a specific controller</li>
	<li>You only add ONE known subdomain per execution</li>
</ol>
	<center><img src="pix/mapsubdomains.jpg" /></center>
</div>

<div class="slide">
<h1>Router: Map several paths</h1>
<p class="problem"><strong>Problem:</strong> I have plenty of known routes that use the same controller</p>
<ol>
	<li>Use a configurtaion file</li>
</ol>
	<center><img src="pix/platformname.jpg" /></center>
</div>

<div class="slide">
<h1>Router: Several Hacks</h1>
<p class="problem"><strong>Problem:</strong> I want any URL to be a "search" by default instead of static pages.</p>
	<center><img src="pix/routermisc.jpg" /></center>
</div>

<div class="slide">
<h1>Rebuild in production</h1>
<p class="problem"><strong>Problem:</strong> Just updated and nothing is working because I didn't rebuild</p>
<ol>
	<li>Duplicate your production VirtualHost with an invalid DNS</li>
	<li>Duplicate your production domains.config with the fake domain, set debug=true and put a password. Add domain to /etc/hosts</li>
	<li>Do not browse the site!</li>
</ol>
	<center><img src="pix/nosmatemos.jpg" /></center>
</div>

<div class="slide">
	<span class="banner">Not obvious</span>
</div>

<div class="slide">
<h1>Cache</h1>
<ul>
	<li>Enable caching with Memcached by editing <code>memcache.config.php</code>. Cache to disk used by default, unefficient</li>
	<li><strong>Define Cache on every parent</strong> (One access to cache, 1 included file instead of N)
		<ul>
			<li><strong>HomeIndexController</strong> instead of:</li>
			<li>SharedHeadController</li>
			<li>SharedMetadataController      </li>
			<li>SharedHeaderController        </li>
			<li>SharedMenuController          </li>
			<li>SharedTabsController          </li>
			<li>SharedSidebarController       </li>
			<li>SharedFilterController        </li>
			<li>SharedLoginBoxController      </li>
			<li>SharedFooterController        </li>
			<li>SharedSystemMessagesController</li>
		</ul>
<		/li>
		</ul>
</div>

<div class="slide">
	<h1>Including classes in Controllers and Models</h1>
	<ul>
	<li><strong>Include classes only</strong> at the beginning
	<pre>
protected $include_classes = 
	array( 'Session', 'Form', 'FlashMessages' );</pre>
	<br/></li>
	<li><strong>Include one class</strong> on demand and optionally return the object
		<ul>
			<li>Return a new object of the class (safe)
<pre>
$myclass = $this->getClass( 'Motorbike', true );
</pre>
			</li>
			<li>Don't return an object (just an include)
<pre>
this->getClass( 'SmokeSeller', false );
</pre>
			</li>
			<li>Use Anywhere<pre>Bootstrap::getClass( $class, $call_constructor = true )</pre></li>
		</ul>
		</li>
	</ul>
</div>



<div class="slide">
<h1>Pre and Post dispatching</h1>
<ul>
	<li><code>preDispatch()</code> and <code>postDispatch()</code> are always executed, no matter if the object is cached.</li>
	<li>Use if for actions that must be done at every execution (be careful)</li>
	<li>Example:
	<pre>
public function preDispatch()
{
	// Redirect when there is no subdomain on a specific page:
	if( false === Domains::getInstance()->getSubdomain() )
	{
		$this->redirectToRightSubdomain();
	}
}
	</pre>	
	</li>
</ul>
</div>

<div class="slide">
<h1>Filter user input <code>Filter.php</code></h1>
<ul>
	<li>USE IT!!! Do not trust on content that might be modified by user</li>
	<li>Use filtering for every case:
		<ul>
			<li>Filter (POST)</li>
			<li>FilterGet</li>
			<li>FilterPost</li>
			<li>FilterCookie</li>
			<li>FilterCustom (Your own filtering)</li>
			<li>FilterEnv</li>
			<li>FilterFiles (Uploaded files)</li>
			<li>FilterRequest (POST, GET and Cookie in one place)</li>
			<li>FilterServer (Apache vars)</li>
			<li>FilterSession</li>
		</ul>
		</li>
</ul>
</div>

<div class="slide">
<h1>Filter user input II <code>Filter.php</code></h1>
<ul>
	<li>Some methods:
		<ul>
			<li>getDate( $var_name, $format = 'd-m-Y' )</li>
			<li>getInArray( $var_name, Array $list_of_elements )</li>
			<li>getUrl( $var_name )</li>
			<li>getRegexp( $var_name, $regexp )</li>
			<li>getIP( $var_name, $min_range = null, $max_range = null )</li>
			<li>getInteger( $var_name, $min_range = null, $max_range = null )</li>
			<li>getFloat( $var_name, $decimal = null )</li>
			<li>getBoolean( $var_name )</li>
			<li>getEmail( $var_name, $check_dns = false )</li>
		</ul>
	</li>
	<li>Utilities
		<ul>
			<li>isSent( $var_name )</li>
			<li>isEmpty( $var_name )</li>
		</ul>
	</li>
		
</ul>
</div>


<div class="slide">
<h1>Forms: Ease the pain</h1>
<p>Create a "xxxx<strong>.form.</strong>config.php</code> file under config/forms folder for every form:</p>
<pre>
$config[] = array(
	'name' => 'email',
	'filter' => 'getEmail',
	'params' => array( true ), // Check also that DNS is valid.
	'error' => I18N::getTranslation( 'Please write a valid email' ),
	'required' => true
);
	
$config[] = array(
	'name' => 'myradio',
	'filter' => 'getInArray',
	'params' => array( array( 'all', 'registered', 'contacts', 'nobody' ) ),
	'error' => I18N::getTranslation( 'Invalid value for field' ),
	'required' => true
);
</pre>
</div>


<div class="slide">
<h1>Forms</h1>
<pre>
protected $include_classes = array( 'Form', 'FlashMessages', '...' );
...
$post = FilterPost::getInstance();
$form = Form::getInstance( $post );

if ( $post->isSent( 'id_user' ) ) // FORM SENT
{
	if ( !<strong>$form->validateElements( 'forms/myform.form' )</strong> ) // Invalid
	{
		$errors = <strong>$form->getErrors()</strong>;
		FlashMessages::set( $this->translate( 'Please correct the errors marked below' ), FlashMessages::MSG_KO );
	}
	else // Validation passed
	{
		$fields = <strong>$form->getFields()</strong>; // Get all field
		$email = <strong>$form->getField( 'email' )</strong>;  // Get one field
		FlashMessages::set( $this->translate( 'Everything is OK' ), FlashMessages::MSG_OK );
	}
}
</pre>
</div>

<div class="slide">
	<h1>Translate your projects</h1>
	<ul>
	<li>In controllers and models: <pre>$this->translate( 'Hello %1 %2', 'Albert', 'Lombarte' )</pre></li>
	<li>Anywhere (e.g: Config files): <pre>I18N::getTranslation( 'Hello %1', array( '%1' => 'Mr. Fucker' ) )</pre></li>
	<li>In templates: <pre>{t 1='Albert' 2='Lombarte'}Hello %1 %2{/t}</pre></li>
	</ul>
	<p>By default all strings are taken from <code>locale/messages_xx_XX.php</code>. Domain can be changed with <code>I18N::getInstance( 'newdomain' ) </code> or with <code>I18n::setDomain</code></p>
</div>

<div class="slide">
	<h1>Maintain translations (disk)</h1>
	<ul>
	<li><code>manager/rebuildI18nLocal</code> Synchronize translations <strong>in disk</strong>
		<ul>
			<li>Finds all strings needed to be translated in controllers, models, configs, forms and templates</li>
			<li>Creates a new messages_en_US from zero containing only existing strings</li>
			<li>Adds missing strings to the rest of languages</li>
			<li>Deletes unexisting strings in the rest of languages</li>
			<li>Sorts the strings and saves all the languages files</li>
		</ul>
	</li>
	</ul>
</div>

<div class="slide">
	<h1>Maintain translations (database)</h1>
	<p>Let users translate for you (Mysql table includes permissions system)</p>
	<center><img src="pix/i18nstatus2.jpg" /></center>
</div>

<div class="slide">
	<h1>Maintain translations (database)</h1>
	<ul>
		<li>Controllers: i18n/status, i18n/save and i18n/rebuild</li>
		<li>Mysql structure and dump under <code>docs/i18n_tables.sql</code></li>
	</ul>
	<center><img src="pix/i18nstatus.jpg" /></center>
</div>

<div class="slide">
	<h1>Maintain translations (manual)</h1>
	<ul>
		<li><strong>manager/findi18n</strong>: Finds all strings that need to be translated and suggests literals and database inserts. Automatic translation with Google Translate</li>
	</ul>
	<center><img src="pix/findi18n.jpg" /></center>
</div>

<div class="slide">
<h1>Rebuild flavour</h1>
	<p>Add all this controllers in you router.config</p>
	<ul>
		<li><code>manager/rebuild</code>: You know this one. Updates the configs, templates and controllers config catalog.</li>
		<li><code>manager/rebuildRouter</code>: Synchronize all router_xx_XX.config files
			<ul>
				<li>Develop writing only in router_en_US (default master file)</li>
				<li>Script adds missing routes to all languages in english</li>
			</ul>
		</li>		
	</ul>
</div>

<div class="slide">
<h1>A lot of code is done</h1>
	<ul>
		<li>Review the "default" instance, is full of nice controllers, models and classes. Check also the libraries. Examples:
			<ul>
				<li>default/classes/HelperPasswordGenerator.php</li>
				<li>libs/SEOframework/API/Youtube.php</li>
				<li>libs/SEOframework/API/Youtube.php</li>				
				<li>libs/RedisModel.php</li>
				<li>libs/Search.php (Sphinx)</li>
				<li>default/models/OAuth/twitter.model.php</li>
			</ul>
		</li>
	</ul>
</div>

<div class="slide">
<h1>Stay tunned</h1>
<ul>
<li>Basecamp: <a href="http://nexoblogs.basecamphq.com/">http://nexoblogs.basecamphq.com/</a></li>
</ul>
</div>

<div class="slide">
	<span class="banner">Hell, thanks!</span>
</div>


</div>

</div>

</body>
</html>
